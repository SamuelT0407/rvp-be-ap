# 代码复用原则

## 核心原则

### DRY (Don't Repeat Yourself)

```
任何逻辑、结构、模式出现 ≥2 次，必须考虑抽取复用
```

---

## 复用层级

### Level 1: API 层复用

#### 检查 API 影响范围

在修改任何 API 函数之前，**必须检查其使用情况**:

```powershell
# 使用全局搜索
Ctrl + Shift + F → 搜索函数名 (如 "listUser")
```

#### 判断策略

| 情况                 | 策略                 |
| -------------------- | -------------------- |
| 仅 1 处使用          | 可直接修改           |
| 多处使用，改动兼容   | 可直接修改           |
| 多处使用，改动不兼容 | 新增函数，保留旧函数 |

#### 示例

```typescript
// ❌ 危险: 直接修改被多处使用的函数
export const listUser = (query: UserQuery) => { ... }

// ✅ 安全: 新增函数，保持旧函数兼容
export const listUser = (query: UserQuery) => { ... }
export const listUserV2 = (query: UserQueryV2) => { ... }  // 新增
```

---

### Level 2: 组件复用

#### 抽取时机

- 相同 Template 结构 ≥2 次
- 相同交互逻辑可复用

#### 抽取位置决策

```
该组件是否会被其他业务模块使用？
    ├── 是 → 放入 src/components/ (全局组件)
    └── 否 → 放入页面同级 components/ (业务组件)
```

#### 详细规范

→ 参见 [conventions/components.md](../conventions/components.md)

---

### Level 3: 工具函数复用

#### 抽取时机

- 相同处理逻辑 ≥2 次
- 纯函数，无副作用

#### 抽取位置决策

```
该函数是否与业务无关？
    ├── 是 → 放入 src/utils/ (通用工具)
    └── 否 → 放入业务模块 utils/ (业务工具)
```

#### 详细规范

→ 参见 [conventions/utils.md](../conventions/utils.md)

---

### Level 4: 类型复用

#### 共享类型

跨模块使用的类型放入:

- `src/api/types.ts` (API 相关公共类型)
- `src/types/` (全局类型定义)

#### 模块内类型

仅模块内使用的类型放入:

- `src/api/{module}/types.ts`

---

## 复用决策流程图

```
发现重复代码
    │
    ▼
判断重复类型
    │
    ├─ API 调用 ────────→ 检查影响范围 → 决定修改/新增
    │
    ├─ Template 结构 ──→ 抽取组件 → 决定全局/业务
    │
    ├─ 逻辑处理 ────────→ 抽取工具函数 → 决定通用/业务
    │
    └─ 类型定义 ────────→ 抽取类型 → 决定共享/模块
```

---

## 反模式 (避免)

### ❌ 过度抽象

```
不要为了复用而复用。如果某段代码仅出现 1 次，保持内联。
```

### ❌ 忽视检查

```
修改 API / 组件 / 工具函数前，必须检查所有调用点。
```

### ❌ 位置混乱

```
全局组件放在业务目录，业务组件放在全局目录，都是错误的。
```

---

## 快速 Checklist

在提交代码前确认:

- [ ] 是否有重复代码可以抽取？
- [ ] 修改的 API/组件/工具是否检查了影响范围？
- [ ] 新抽取的代码放置位置是否正确？
- [ ] 是否添加了必要的类型定义和注释？
